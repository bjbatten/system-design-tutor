<div id="message-<%= message.id %>" class="mb-4 <%= message.role == 'user' ? 'text-right' : 'text-left' %>">
  <div class="inline-block <%= message.role == 'user' ? 'bg-blue-500 text-white' : 'bg-gray-200' %> rounded-lg px-4 py-2 max-w-3xl">
    <div class="text-xs opacity-75 mb-1"><%= message.role %></div>
    
    <% if message.role == 'assistant' && message.content.include?('```mermaid') %>
      <% # Split content by mermaid blocks %>
      <% parts = message.content.split(/(```mermaid.*?```)/m) %>
      
      <% parts.each do |part| %>
        <% if part.match?(/```mermaid/) %>
          <%# This is a mermaid code block %>
          <% mermaid_code = part.match(/```mermaid\n(.*?)\n```/m)&.captures&.first %>
          <% if mermaid_code %>
            <div class="my-4 bg-white p-4 rounded border" data-controller="mermaid">
              <%= mermaid_code.strip %>
            </div>
            
            <!-- Action buttons for diagram refinement -->
            <div class="mt-2 mb-4 flex gap-2 flex-wrap">
              <%= button_to "Scale to 10x users", 
                            conversation_messages_path(message.conversation), 
                            method: :post,
                            params: { message: { role: 'user', content: 'Scale this design to handle 10x more users' } },
                            class: "text-xs bg-white text-gray-700 px-3 py-1 rounded border hover:bg-gray-50",
                            data: { turbo_frame: "messages" } %>
              
              <%= button_to "Add monitoring", 
                            conversation_messages_path(message.conversation), 
                            method: :post,
                            params: { message: { role: 'user', content: 'Add monitoring and observability to this design' } },
                            class: "text-xs bg-white text-gray-700 px-3 py-1 rounded border hover:bg-gray-50",
                            data: { turbo_frame: "messages" } %>
              
              <%= button_to "Optimize for cost", 
                            conversation_messages_path(message.conversation), 
                            method: :post,
                            params: { message: { role: 'user', content: 'Optimize this design to reduce infrastructure costs' } },
                            class: "text-xs bg-white text-gray-700 px-3 py-1 rounded border hover:bg-gray-50",
                            data: { turbo_frame: "messages" } %>
            </div>
          <% end %>
        <% else %>
          <%# This is regular text %>
          <% unless part.strip.empty? %>
            <div class="whitespace-pre-wrap my-2"><%= part.strip %></div>
          <% end %>
        <% end %>
      <% end %>
    <% else %>
      <div class="whitespace-pre-wrap"><%= message.content %></div>
    <% end %>
  </div>
</div>